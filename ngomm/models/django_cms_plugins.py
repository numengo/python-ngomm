from ngoschema import get_builder
from ngomm import settings

builder = get_builder()

# = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/")



BootstrapAccordionPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapAccordionPluginModel")
BootstrapAccordionGroupPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapAccordionGroupPluginModel")
BootstrapButtonPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapButtonPluginModel")
BootstrapCardHeaderPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCardHeaderPluginModel")
BootstrapCardBodyPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCardBodyPluginModel")
BootstrapCardFooterPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCardFooterPluginModel")
BootstrapCardPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCardPluginModel")
BootstrapImagePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapImagePluginModel")
BootstrapPicturePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapPicturePluginModel")
#BootstrapCarouselPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCarouselPluginModel")
#BootstrapCarouselSlidePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapCarouselSlidePluginModel")
BootstrapContainerPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapContainerPluginModel")
BootstrapRowPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapRowPluginModel")
BootstrapColumnPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapColumnPluginModel")
BootstrapYoutubePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapYoutubePluginModel")
FramedIconPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/FramedIconPluginModel")
BootstrapJumbotronPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapJumbotronPluginModel")
BootstrapTabSetPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapTabSetPluginModel")
BootstrapTabPanePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapTabPanePluginModel")
BootstrapSecondaryMenuPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BootstrapSecondaryMenuPluginModel")
SegmentPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/SegmentPluginModel")
SimpleWrapperPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/SimpleWrapperPluginModel")
HorizontalRulePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/HorizontalRulePluginModel")
HeadingPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/HeadingPluginModel")
CustomSnippetPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/CustomSnippetPluginModel")
TextImagePlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/TextImagePluginModel")
TextIconPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/TextIconPluginModel")
#LeafletPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/LeafletPluginModel")
TextLinkPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/TextLinkPluginModel")
#ShopAuthenticationPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopAuthenticationPluginModel")
BreadcrumbPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/BreadcrumbPluginModel")
#ShopCatalogPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopCatalogPluginModel")
#ShopAddToCartPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopAddToCartPluginModel")
#ShopProductGalleryPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopProductGalleryModel")
#ShopLeftExtensionPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopLeftExtensionModel")
#ShopRightExtensionPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopRightExtensionModel")
#ShopCartPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopCartPluginModel")
#ShopProceedButtonPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopProceedButtonModel")
#CustomerFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/CustomerFormPluginModel")
#GuestFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/GuestFormPluginModel")
#CheckoutAddressPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/CheckoutAddressPluginModel")
#PaymentMethodFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/PaymentMethodFormPluginModel")
#ShippingMethodFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShippingMethodFormPluginModel")
#ExtraAnnotationFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ExtraAnnotationFormPluginModel")
#RequiredFormFieldsPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/RequiredFormFieldsPluginModel")
#ValidateSetOfFormsPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ValidateSetOfFormsPluginModel")
#ShopOrderViewsPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopOrderViewsPluginModel")
#ShopReorderButtonPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopReorderButtonPluginModel")
#ShopCancelOrderButtonPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopCancelOrderButtonPluginModel")
#ShopOrderAddendumFormPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopOrderAddendumFormPluginModel")
#ProcessBarPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ProcessBarPluginModel")
#ProcessStepPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ProcessStepPluginModel")
#ShopSearchResultsPlugin = builder.resolve_or_construct("http://numengo.org/django#/definitions/cmsplugin_cascade/definitions/ShopSearchResultsPluginModel")


def insertPlugin(mm_pl ,db_page, position='last-child' ,db_target=None):
    logger = logging.getLogger(__name__)
    from cms.api import add_plugin
    mgr = pageMgr()

    slot = mm_pl.placeholder().slot
    db_ph = db_page.placeholders.get(slot=slot)

    mm_translation = mm_pl.placeholder().translation()
    language = mm_translation.language

    cms_translation = mgr.cms_page_pk(db_page.pk).translation(language)
    # get cms_ph or create it
    cms_ph = cms_translation.placeholder(slot)
    if cms_ph is None:
        etree.SubElement(cms_translation.node ,'placeholder' ,SLOT=slot)
        cms_ph = cms_translation.placeholder(slot)
        assert cms_ph is not None, "%s %s " %(cms_translation.id ,slot)

    # position
    cms_target = cms_ph
    if db_target:
        cms_target = mgr.cms_plugin_pk(db_target.pk)
        assert cms_target is not None, db_target.pk
        if position == 'last-child':
            # new_pos = len(cms_target.placeholder().plugins())
            new_pos = len(cms_target.node.findall('plugin'))
        elif position == 'first-child':
            new_pos = 0
        elif position == 'left':
            new_pos = cms_target.position
        elif position == 'right':
            new_pos = cms_target.position + 1
        else:
            raise Exception('position not supported: %s' % position)
    else:
        new_pos = len(cms_translation.placeholder(slot).plugins())

    def addLicenseDisclaimer(mm_pl):
        # license
        original_title = mm_pl.get('title' ,'picture/drawing')
        author = mm_pl.get('author')
        source = mm_pl.get('source_url')
        license = mm_pl.get('license')
        license_url = mm_pl.get('license_url')
        disclaimer = None
        if license is not None or license_url is not None:
            disclaimer = [original_title]
            if author is not None and source is not None:
                author = "<a href=%s>%s</a> " %(source ,author)
            if author is not None:
                disclaimer.append('by %s ' %author)
            import re
            if license_url is not None and license is None:
                license = re.split('[/:]' ,license_url)[-1]
                license = license.replace('_' ,' ')
            if license is not None:
                if license_url is not None:
                    license = "<a href=%s>%s</a> " %(license_url ,license)
                disclaimer.append('under %s ' %license)
            disclaimer = ','.join(disclaimer)
        if disclaimer is not None:
            logger.debug('adding license disclaimer')
            db_ph_lic = db_page.placeholders.get(slot="license_disclaimer")
            db_pl2 = add_plugin(db_ph_lic, 'TextPlugin', language, "last-child", body='<p id="%s">%s</p> ' %(mm_pl.id ,disclaimer))
            # get cms_ph2 or create it
            # cms_ph2 = cms_translation.placeholder('license_disclaimer')
            # if cms_ph2 is None:
            #    etree.SubElement(cms_translation.node,'placeholder',SLOT='license_disclaimer')
            #    cms_ph2 = cms_translation.placeholder('license_disclaimer')
            #    assert cms_ph2 is not None, cms_translation.id
            # cms_ph2.node.append(etree.Element('plugin',ID=mm_pl.id,PK=str(db_pl2.pk),MODIFIED=str(mm_pl.modified)))




    if mm_pl.type == 'TextPlugin':
        logger.debug('adding text')
        body ='<p id="%s">%s</p> ' %(mm_pl.id ,mm_pl.content)
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=body)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'Title':
        logger.debug('adding title')
        body ='<h1 id="%s">%s</h1> ' %(mm_pl.id ,mm_pl.plaincontent)
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=body)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'SubTitle':
        logger.debug('adding h2')
        body ='<h2 id="%s">%s</h2> ' %(mm_pl.id ,mm_pl.plaincontent)
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=body)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'SubSubTitle':
        logger.debug('adding h3')
        body ='<h3 id="%s">%s</h3> ' %(mm_pl.id ,mm_pl.plaincontent)
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=body)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'Quote':
        logger.debug('adding quote')
        quote_content = '<blockquote id="%s">%s<footer><cite>%s</cite></footer></blockquote> ' % \
        (mm_pl.id ,mm_pl.plaincontent ,mm_pl.get('author'))
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=quote_content)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'Tip':
        logger.debug('adding tip')
        tip_content = '<div id="%s" class="hottip"><table><tr><td id="imageTD" width="72px"><img src="/media/images/tip_64.png" width="64px"/></td><td id="contentTD"><p>%s</p></td></tr></table></div> ' % \
        (mm_pl.id ,mm_pl.plaincontent)
        db_pl = add_plugin(db_ph, 'TextPlugin', language, position, db_target, body=tip_content)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
    elif mm_pl.type == 'VimeoVideoPlugin':
        logger.debug('adding video')
        movie_url =mm_pl.get('movie_url' ,'https://vimeo.com/109688033')
        auto_play =(mm_pl.get('auto_play' ,'false' )=='true')
        loop =(mm_pl.get('loop' ,'false' )=='true')
        alignment = mm_pl.get('alignment')
        # (320,180) (425,344) (640,360) (800,450) (1024,575) (1280,720) (1600,900) (1980,1113)
        size = mm_pl.get('width' ,'1024x575')
        if size is not None:
            width ,height = [int(x) for x in size.split("x")]
        else:
            width = int(mm_pl.get('width' ,'1024'))
            height = int(mm_pl.get('height' ,'575'))
        vimeo_ref = movie_url.split('/')[-1]
        db_pl = add_plugin(db_ph, 'VimeoPlugin', language, position, db_target, video_id=vimeo_ref,
                           autoplay=auto_play, loop=loop ,width=width, height=height ,alignment=alignment)
        cms_target.node.insert(new_pos
                               ,etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified)))
        addLicenseDisclaimer(mm_pl)

    elif mm_pl.type == 'FilerImagePlugin':
        logger.debug('adding image')
        caption_text = mm_pl.get('caption_text' ,'')
        alignment = mm_pl.get('alignment')
        style = mm_pl.getAttribute('style' ,'default')

        from django.core.files import File
        from filer.models import Image
        image = None
        if mm_pl.node.find('hook') is not None:
            # filepath = mm_dir.joinpath(mm_pl.node.find('hook').get('URI'))
            filepath  = mm_dir + os.sep + os.path.normpath(mm_pl.node.find('hook').get('URI'))
            filepath = os.path.normpath(filepath)
            filename = os.path.split(filepath)[-1]
            relpath = os.path.relpath(filepath ,media_root)
            with open(filepath ,'rb') as f:
                file_obj = File(f, name=filename)
                image = Image.objects.create(original_filename=filename ,name=relpath,
                                             file=file_obj)
                image.save()
        image_url = mm_pl.get('image_url' ,'')
        # description
        description = None
        if mm_pl.note is not None:
            description = etree.tostring(etree.fromstring(mm_pl.note) ,encoding='utf-8' ,method="text").decode \
                ('utf-8').strip()
            # description = etree.tostring(etree.fromstring(mm_pl.note),encoding='utf-8',method="text").decode('unicode-escape') # to remove any html tag in description
        # alt_text
        alt_text = mm_pl.get('alt_text')
        # if alt_text is None and description is not None: # not alt_text but description ? use description
        #    alt_text = description
        focusKeyword = mm_pl.placeholder().translation().seo.focusKeyword
        if alt_text is None and focusKeyword is not None:
            alt_text = focusKeyword
        if alt_text is None:
            alt_text = mm_pl.translation().menu_title()
        if mm_pl.translation().get('silo_title') is not None:
            alt_text = '%s - %s ' %(alt_text ,mm_pl.translation().get('silo_title'))
        elif mm_pl.translation().parent() is not None and mm_pl.translation().parent().get('silo_title'):
            alt_text = '%s - %s ' %(alt_text ,mm_pl.translation().get('silo_title'))
        width = mm_pl.get('width' ,None)
        if width is not None: width = int(width)
        height = mm_pl.get('height' ,None)
        if height is not None: height = int(height)

        db_pl = add_plugin(db_ph, 'FilerImagePlugin', language, position, db_target, caption_text=caption_text,
                           image=image ,image_url=image_url, alt_text=alt_text, description=description ,width=width
                           ,height=height ,alignment=alignment ,style=style)
        db_pl.render_templat e ='cmsplugin_filer_image/plugins/image/srcset.html'
        db_pl.save()
        cms_pl = etree.Element('plugin' ,ID=mm_pl.id ,PK=str(db_pl.pk) ,MODIFIED=str(mm_pl.modified))
        cms_target.node.insert(new_pos ,cms_pl)
        addLicenseDisclaimer(mm_pl)

    elif mm_pl.type == 'MultiColumnPlugin':
        logger.debug('adding multicolumn')
        db_mcol = add_plugin(db_ph, 'MultiColumnPlugin', language, position, target=db_target)
        # logger.info('db_mcol %i position %i'%(db_mcol.pk,db_mcol.position))
        db_pl = db_mcol
        cms_mcol = etree.Element('plugin' ,ID=mm_pl.id ,typ="MultiColumn" ,PK=str(db_mcol.pk)
                                 ,MODIFIED=str(mm_pl.modified))
        cms_target.node.insert(new_pos ,cms_mcol)
        mm_cols = [mm_node(c2) for c2 in mm_pl.node.getchildren() if c2.get('TEXT' )= ="COLUMN"]
        mm_cols = [c2 for c2 in mm_cols if 'button_cancel' not in c2.icons]
        def_width = 100 / len(mm_cols)
        db_cols = []
        for mm_col in mm_cols:
            logger.debug('adding column')
            width = mm_col.get('width' ,str(def_width))
            if not width.endswith('%'): width += '%'
            db_col = add_plugin(db_ph, 'ColumnPlugin', language, "last-child", target=db_mcol, **{'width': '%s ' %width})
            # db_col.move_to(db_mcol,'last-child')
            db_cols.append(db_col)
            cms_col = etree.SubElement(cms_mcol ,'plugin' ,typ="Column" ,ID=mm_col.id ,PK=str(db_col.pk)
                                       ,MODIFIED=str(mm_col.modified))
            col_content = [c2 for c2 in mm_col.getChildren() if c2.text not in TOSKIP and 'button_cancel' not in c2.icons]
            for n in col_content:
                mm_pl2 = mmPage.mmTranslation.mmPlaceholder.mmPlugin(n.node)
                insertPlugin(mm_pl2 ,db_page ,"last-child" ,db_target=db_col)
            db_col.save()
        curcol = None
        for db_col ,i in zip(db_cols ,range(len(db_cols))):
            # logger.debug('#++++ %i - %i'%(db_col.position,i))
            if i== 0:
                db_col.move_to(db_mcol, position="first-child")
            else:
                db_col.move_to(curcol, position="right")
            curcol = db_col

            # db_col.position = i
            db_col.save()
            # logger.debug('#--- %i - %i'%(db_col.position,i))
        db_mcol.save()
        # logger.info('db_mcol %i position %i'%(db_mcol.pk,db_mcol.position))

        # content2 = [mm_node(c2) for c2 in mm_pl.node.getchildren() if c2.get('TEXT') not in TOSKIP]
        # width = 100/len(content2)
        # for column_content in content2:
        #    col = add_plugin(db_ph, 'ColumnPlugin', language, position, db_target,
        #                     target=db_mcol, **{'width': '%i%'%width})
        #    cms_col = etree.SubElement(cms_mcol,'plugin',ID=column_content.id,PK=str(col.pk),MODIFIED=str(mm_pl.modified))
        #    db_pl = add_plugin(db_ph, 'TextPlugin', language, body='<p>%s</p>'%column_content.content,
        #               target=col)
        #    etree.SubElement(cms_col,'plugin',ID=column_content.id,PK=str(db_pl.pk),MODIFIED=str(column_content.modified))

        # logger.info('page[pk=%i] %s[pk=%i,id=%s]: %s'%(db_page.pk,db_pl.plugin_type,db_pl.pk,mm_pl.id,position))

    elif mm_pl.type == 'StylePlugin':
        """
        def findFinalPlugin(pl):
            pls = mmPage.mmTranslation.mmPlaceholder(pl.node).plugins(with_title=False)
            assert len(pls)==1, "StylePlugin[%s] doesn't have one child plugin"%pl.id
            pl2 = pls[0] 
            if pl2.type == 'StylePlugin':
                return findFinalPlugin(pl2)
            return pl2

        mm_pl2 = findFinalPlugin(mm_pl)
        db_pl2 = insertPlugin(mm_pl2,db_page,"last-child",db_target=None)
        cms_pl2 = cms_target.node.find('plugin[@PK="%i"]'%db_pl2.pk)
        assert cms_pl2 is not None, "can't find plugin PK=%i ID=%s"%(db_pl2.pk,mm_pl2.id)
        cms_target.node.remove(cms_pl2)
        def applyStyle(mm_pl,cms_pl,db_pl):
            #we need to move backwards
            mm_pl2 = mm_node(mm_pl.node.getparent())
            if mm_pl2.getAttribute('type')=='StylePlugin':
                class_name = mm_pl2.getAttribute('class_name')        
                div_id = mm_pl2.getAttribute('div_id')
                inline_style = mm_pl2.getAttribute('inline_style')
                javascript = mm_pl2.getAttribute('javascript')
                logger.info('adding div with class "%s" to plugin ID=%s'%(class_name,mm_pl.id))
                db_pl2 = add_plugin(db_ph, 'TmStylePlugin', language, position,db_pl,class_name=class_name,div_id=div_id,inline_style=inline_style,javascript=javascript)
                cms_pl2 = etree.Element('plugin',ID=mm_pl2.id,typ="Style",PK=str(db_pl2.pk),MODIFIED=str(mm_pl2.modified),CLASS_NAME=class_name)
                cms_pl2.append(cms_pl)
                applyStyle(mm_pl2,cms_pl2,db_pl2)
            # when parent is no longer a style, we can return the xml object and add it to the tree
            return cms_pl
        cms_pl = applyStyle(mm_pl2,cms_pl2,db_pl2)
        cms_target.node.insert(new_pos,cms_pl)
        db_pl = db_pl2
        """
        class_name = mm_pl.getAttribute('class_name')
        div_id = mm_pl.getAttribute('div_id')
        inline_style = mm_pl.getAttribute('inline_style')
        javascript = mm_pl.getAttribute('javascript')
        # db_pl = add_plugin(db_ph, 'StylePlugin', language, position,db_target,class_name=class_name.split()[0])
        db_pl = add_plugin(db_ph, 'TmStylePlugin', language, position, db_target, class_name=class_name, div_id=div_id,
                           inline_style=inline_style, javascript=javascript)
        # logger.info('db_style %i position %i'%(db_pl.pk,db_pl.position))
        cms_style = etree.Element('plugin', ID=mm_pl.id, typ="Style", PK=str(db_pl.pk), MODIFIED=str(mm_pl.modified))
        cms_target.node.insert(new_pos, cms_style)
        style_content = [c2 for c2 in mm_pl.getChildren() if c2.text not in TOSKIP and 'button_cancel' not in c2.icons]
        for n in style_content:
            mm_pl2 = mmPage.mmTranslation.mmPlaceholder.mmPlugin(n.node)
            db_pl2 = insertPlugin(mm_pl2, db_page, "last-child", db_target=db_pl)
            # logger.info('adding children[%i] to style[%i]'%(db_pl2.pk,db_pl.pk))
            # logger.info("pk[%i] pos[%i]"%(db_pl2.pk,db_pl2.position))

        # logger.info('page[pk=%i] %s[pk=%i,id=%s]: %s'%(db_page.pk,db_pl.plugin_type,db_pl.pk,mm_pl.id,position))

    elif mm_pl.type == 'ParallaxPlugin':
        image = mm_pl.getAttribute('image')
        db_pl = add_plugin(db_ph, 'TmParallaxPlugin', language, position, db_target, image=image)
        # logger.info('db_parallax %i position %i'%(db_pl.pk,db_pl.position))
        cms_prlx = etree.Element('plugin', ID=mm_pl.id, typ="Parallax", PK=str(db_pl.pk), MODIFIED=str(mm_pl.modified))
        cms_target.node.insert(new_pos, cms_prlx)
        parallax_content = [c2 for c2 in mm_pl.getChildren() if
                            c2.text not in TOSKIP and 'button_cancel' not in c2.icons]
        for n in parallax_content:
            mm_pl2 = mmPage.mmTranslation.mmPlaceholder.mmPlugin(n.node)
            db_pl2 = insertPlugin(mm_pl2, db_page, "last-child", db_target=db_pl)
            # logger.info('adding children[%i] to parallax[%i]'%(db_pl2.pk,db_pl.pk))
            # logger.info("pk[%i] pos[%i]"%(db_pl2.pk,db_pl2.position))
    else:
        logger.error('Unknown type %s for node %r' % (mm_pl.type, mm_pl))

    return db_pl
